name: Build+Test Pipeline

on:
  pull_request:
    branches:
      - dev

jobs:
  build-docker:
    name: 'Build and Test'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v2
      with:
        submodules: 'true'
        token: ${{ secrets.TESTING_DATA_PAT }}

    - name: 'Get Go'
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'
        cache-dependency-path: "go.sum"

    - name: 'Get CMake'
      uses: symbitic/install-cmake@master

    - name: 'Build and Cache OpenCV'
      uses: UrielCh/opencv-cache-action@V1
      with:
        branch: 4.x
        BUILD_LIST: core,imgproc,imgcodecs,videoio,highgui,video,calib3d,features2d,objdetect,dnn,ml,photo,gapi,python3
        NO_CONTRIB: ''

    - name: 'Update pkg list'
      run: sudo apt update

    - name: 'Install and Cache Fyne Dependencies'
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: gcc libgl1-mesa-dev xorg-dev dbus-x11
        version: 1.0

    - name: 'Install and Cache OCR Tesseract'
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: libtesseract-dev tesseract-ocr-deu tesseract-ocr
        version: 1.0
        
    - name: 'Install and configure opencv build'
      run: export PKG_CONFIG_PATH="/usr/lib/pkgconfig" && echo "--Install--" && cd ../build && sudo make preinstall && sudo make install && echo "--Config--" && sudo ldconfig

    - name: 'Build'
      run: export DISPLAY="0" && export CGO_CXXFLAGS="--std=c++11" && export CGO_CPPFLAGS="-I/home/runner/work/YAAC/opencv/3rdparty/carotene/include -I/home/runner/work/YAAC/opencv/3rdparty/flatbuffers/include -I/home/runner/work/YAAC/opencv/3rdparty/include -I/home/runner/work/YAAC/opencv/3rdparty/ittnotify/include -I/home/runner/work/YAAC/opencv/3rdparty/openvx/include -I/home/runner/work/YAAC/opencv/3rdparty/quirc/include -I/home/runner/work/YAAC/opencv/include -I/home/runner/work/YAAC/opencv/modules/calib3d/include -I/home/runner/work/YAAC/opencv/modules/core/include -I/home/runner/work/YAAC/opencv/modules/dnn/include -I/home/runner/work/YAAC/opencv/modules/dnn/src/ocl4dnn/include -I/home/runner/work/YAAC/opencv/modules/dnn/src/vkcom/include -I/home/runner/work/YAAC/opencv/modules/features2d/include -I/home/runner/work/YAAC/opencv/modules/flann/include -I/home/runner/work/YAAC/opencv/modules/gapi/include -I/home/runner/work/YAAC/opencv/modules/highgui/include -I/home/runner/work/YAAC/opencv/modules/imgcodecs/include -I/home/runner/work/YAAC/opencv/modules/imgproc/include -I/home/runner/work/YAAC/opencv/modules/ml/include -I/home/runner/work/YAAC/opencv/modules/objdetect/include -I/home/runner/work/YAAC/opencv/modules/photo/include -I/home/runner/work/YAAC/opencv/modules/stitching/include -I/home/runner/work/YAAC/opencv/modules/ts/include -I/home/runner/work/YAAC/opencv/modules/video/include -I/home/runner/work/YAAC/opencv/modules/videoio/include -I/home/runner/work/YAAC/opencv/modules/world/include -I/home/runner/work/YAAC/opencv/platforms/android/aar-template/OpenCV/src/main/cpp/include -I/home/runner/work/YAAC/opencv/platforms/semihosting/include -I/home/runner/work/YAAC/opencv/samples/semihosting/include -I/home/runner/work/YAAC/opencv_contrib/modules/alphamat/include -I/home/runner/work/YAAC/opencv_contrib/modules/aruco/include -I/home/runner/work/YAAC/opencv_contrib/modules/bgsegm/include -I/home/runner/work/YAAC/opencv_contrib/modules/bioinspired/include -I/home/runner/work/YAAC/opencv_contrib/modules/cannops/include -I/home/runner/work/YAAC/opencv_contrib/modules/ccalib/include -I/home/runner/work/YAAC/opencv_contrib/modules/cnn_3dobj/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaarithm/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudabgsegm/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudacodec/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudafeatures2d/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudafilters/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaimgproc/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudalegacy/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaobjdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaoptflow/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudastereo/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudawarping/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudev/include -I/home/runner/work/YAAC/opencv_contrib/modules/cvv/include -I/home/runner/work/YAAC/opencv_contrib/modules/datasets/include -I/home/runner/work/YAAC/opencv_contrib/modules/dnn_objdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/dnn_superres/include -I/home/runner/work/YAAC/opencv_contrib/modules/dpm/include -I/home/runner/work/YAAC/opencv_contrib/modules/face/include -I/home/runner/work/YAAC/opencv_contrib/modules/freetype/include -I/home/runner/work/YAAC/opencv_contrib/modules/fuzzy/include -I/home/runner/work/YAAC/opencv_contrib/modules/hdf/include -I/home/runner/work/YAAC/opencv_contrib/modules/hfs/include -I/home/runner/work/YAAC/opencv_contrib/modules/img_hash/include -I/home/runner/work/YAAC/opencv_contrib/modules/intensity_transform/include -I/home/runner/work/YAAC/opencv_contrib/modules/julia/include -I/home/runner/work/YAAC/opencv_contrib/modules/line_descriptor/include -I/home/runner/work/YAAC/opencv_contrib/modules/matlab/include -I/home/runner/work/YAAC/opencv_contrib/modules/mcc/include -I/home/runner/work/YAAC/opencv_contrib/modules/optflow/include -I/home/runner/work/YAAC/opencv_contrib/modules/ovis/include -I/home/runner/work/YAAC/opencv_contrib/modules/phase_unwrapping/include -I/home/runner/work/YAAC/opencv_contrib/modules/plot/include -I/home/runner/work/YAAC/opencv_contrib/modules/quality/include -I/home/runner/work/YAAC/opencv_contrib/modules/rapid/include -I/home/runner/work/YAAC/opencv_contrib/modules/reg/include -I/home/runner/work/YAAC/opencv_contrib/modules/rgbd/include -I/home/runner/work/YAAC/opencv_contrib/modules/saliency/include -I/home/runner/work/YAAC/opencv_contrib/modules/sfm/include -I/home/runner/work/YAAC/opencv_contrib/modules/shape/include -I/home/runner/work/YAAC/opencv_contrib/modules/stereo/include -I/home/runner/work/YAAC/opencv_contrib/modules/structured_light/include -I/home/runner/work/YAAC/opencv_contrib/modules/superres/include -I/home/runner/work/YAAC/opencv_contrib/modules/surface_matching/include -I/home/runner/work/YAAC/opencv_contrib/modules/text/include -I/home/runner/work/YAAC/opencv_contrib/modules/tracking/include -I/home/runner/work/YAAC/opencv_contrib/modules/videostab/include -I/home/runner/work/YAAC/opencv_contrib/modules/viz/include -I/home/runner/work/YAAC/opencv_contrib/modules/wechat_qrcode/include -I/home/runner/work/YAAC/opencv_contrib/modules/xfeatures2d/include -I/home/runner/work/YAAC/opencv_contrib/modules/ximgproc/include -I/home/runner/work/YAAC/opencv_contrib/modules/xobjdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/xphoto/include -I/home/runner/work/YAAC/build/3rdparty/ippicv/ippicv_lnx/icv/include -I/home/runner/work/YAAC/build/3rdparty/ippicv/ippicv_lnx/iw/include -I/home/runner/work/YAAC/build/3rdparty/ade/ade-0.1.2d/sources/ade/include -I/home/runner/work/YAAC/build/include -I/home/runner/work/YAAC/build" && export CGO_LDFLAGS="-L/home/runner/work/YAAC/build -L/home/runner/work/YAAC/build -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_videoio -lopencv_highgui -lopencv_video -lopencv_calib3d -lopencv_features2d -lopencv_objdetect -lopencv_dnn -lopencv_ml -lopencv_photo -lopencv_gapi" && go build -o ./build/yaac -tags customenv ./cmd/yaac/main.go

    - name: 'Test'
      run: export DISPLAY="0" && export CGO_CXXFLAGS="--std=c++11" && export CGO_CPPFLAGS="-I/home/runner/work/YAAC/opencv/3rdparty/carotene/include -I/home/runner/work/YAAC/opencv/3rdparty/flatbuffers/include -I/home/runner/work/YAAC/opencv/3rdparty/include -I/home/runner/work/YAAC/opencv/3rdparty/ittnotify/include -I/home/runner/work/YAAC/opencv/3rdparty/openvx/include -I/home/runner/work/YAAC/opencv/3rdparty/quirc/include -I/home/runner/work/YAAC/opencv/include -I/home/runner/work/YAAC/opencv/modules/calib3d/include -I/home/runner/work/YAAC/opencv/modules/core/include -I/home/runner/work/YAAC/opencv/modules/dnn/include -I/home/runner/work/YAAC/opencv/modules/dnn/src/ocl4dnn/include -I/home/runner/work/YAAC/opencv/modules/dnn/src/vkcom/include -I/home/runner/work/YAAC/opencv/modules/features2d/include -I/home/runner/work/YAAC/opencv/modules/flann/include -I/home/runner/work/YAAC/opencv/modules/gapi/include -I/home/runner/work/YAAC/opencv/modules/highgui/include -I/home/runner/work/YAAC/opencv/modules/imgcodecs/include -I/home/runner/work/YAAC/opencv/modules/imgproc/include -I/home/runner/work/YAAC/opencv/modules/ml/include -I/home/runner/work/YAAC/opencv/modules/objdetect/include -I/home/runner/work/YAAC/opencv/modules/photo/include -I/home/runner/work/YAAC/opencv/modules/stitching/include -I/home/runner/work/YAAC/opencv/modules/ts/include -I/home/runner/work/YAAC/opencv/modules/video/include -I/home/runner/work/YAAC/opencv/modules/videoio/include -I/home/runner/work/YAAC/opencv/modules/world/include -I/home/runner/work/YAAC/opencv/platforms/android/aar-template/OpenCV/src/main/cpp/include -I/home/runner/work/YAAC/opencv/platforms/semihosting/include -I/home/runner/work/YAAC/opencv/samples/semihosting/include -I/home/runner/work/YAAC/opencv_contrib/modules/alphamat/include -I/home/runner/work/YAAC/opencv_contrib/modules/aruco/include -I/home/runner/work/YAAC/opencv_contrib/modules/bgsegm/include -I/home/runner/work/YAAC/opencv_contrib/modules/bioinspired/include -I/home/runner/work/YAAC/opencv_contrib/modules/cannops/include -I/home/runner/work/YAAC/opencv_contrib/modules/ccalib/include -I/home/runner/work/YAAC/opencv_contrib/modules/cnn_3dobj/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaarithm/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudabgsegm/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudacodec/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudafeatures2d/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudafilters/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaimgproc/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudalegacy/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaobjdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudaoptflow/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudastereo/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudawarping/include -I/home/runner/work/YAAC/opencv_contrib/modules/cudev/include -I/home/runner/work/YAAC/opencv_contrib/modules/cvv/include -I/home/runner/work/YAAC/opencv_contrib/modules/datasets/include -I/home/runner/work/YAAC/opencv_contrib/modules/dnn_objdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/dnn_superres/include -I/home/runner/work/YAAC/opencv_contrib/modules/dpm/include -I/home/runner/work/YAAC/opencv_contrib/modules/face/include -I/home/runner/work/YAAC/opencv_contrib/modules/freetype/include -I/home/runner/work/YAAC/opencv_contrib/modules/fuzzy/include -I/home/runner/work/YAAC/opencv_contrib/modules/hdf/include -I/home/runner/work/YAAC/opencv_contrib/modules/hfs/include -I/home/runner/work/YAAC/opencv_contrib/modules/img_hash/include -I/home/runner/work/YAAC/opencv_contrib/modules/intensity_transform/include -I/home/runner/work/YAAC/opencv_contrib/modules/julia/include -I/home/runner/work/YAAC/opencv_contrib/modules/line_descriptor/include -I/home/runner/work/YAAC/opencv_contrib/modules/matlab/include -I/home/runner/work/YAAC/opencv_contrib/modules/mcc/include -I/home/runner/work/YAAC/opencv_contrib/modules/optflow/include -I/home/runner/work/YAAC/opencv_contrib/modules/ovis/include -I/home/runner/work/YAAC/opencv_contrib/modules/phase_unwrapping/include -I/home/runner/work/YAAC/opencv_contrib/modules/plot/include -I/home/runner/work/YAAC/opencv_contrib/modules/quality/include -I/home/runner/work/YAAC/opencv_contrib/modules/rapid/include -I/home/runner/work/YAAC/opencv_contrib/modules/reg/include -I/home/runner/work/YAAC/opencv_contrib/modules/rgbd/include -I/home/runner/work/YAAC/opencv_contrib/modules/saliency/include -I/home/runner/work/YAAC/opencv_contrib/modules/sfm/include -I/home/runner/work/YAAC/opencv_contrib/modules/shape/include -I/home/runner/work/YAAC/opencv_contrib/modules/stereo/include -I/home/runner/work/YAAC/opencv_contrib/modules/structured_light/include -I/home/runner/work/YAAC/opencv_contrib/modules/superres/include -I/home/runner/work/YAAC/opencv_contrib/modules/surface_matching/include -I/home/runner/work/YAAC/opencv_contrib/modules/text/include -I/home/runner/work/YAAC/opencv_contrib/modules/tracking/include -I/home/runner/work/YAAC/opencv_contrib/modules/videostab/include -I/home/runner/work/YAAC/opencv_contrib/modules/viz/include -I/home/runner/work/YAAC/opencv_contrib/modules/wechat_qrcode/include -I/home/runner/work/YAAC/opencv_contrib/modules/xfeatures2d/include -I/home/runner/work/YAAC/opencv_contrib/modules/ximgproc/include -I/home/runner/work/YAAC/opencv_contrib/modules/xobjdetect/include -I/home/runner/work/YAAC/opencv_contrib/modules/xphoto/include -I/home/runner/work/YAAC/build/3rdparty/ippicv/ippicv_lnx/icv/include -I/home/runner/work/YAAC/build/3rdparty/ippicv/ippicv_lnx/iw/include -I/home/runner/work/YAAC/build/3rdparty/ade/ade-0.1.2d/sources/ade/include -I/home/runner/work/YAAC/build/include -I/home/runner/work/YAAC/build" && export CGO_LDFLAGS="-L/home/runner/work/YAAC/build -L/home/runner/work/YAAC/build -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_videoio -lopencv_highgui -lopencv_video -lopencv_calib3d -lopencv_features2d -lopencv_objdetect -lopencv_dnn -lopencv_ml -lopencv_photo -lopencv_gapi" && go test -v ./test/ -tags customenv

    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v3
      with:
        name: yaay
        path: ./build/yaac
        retention-days: 1
